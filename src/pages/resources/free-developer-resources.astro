---
import Layout from '../../layouts/Layout.astro';
import resourcesData from '../../data/resources.json';

interface Resource {
  title: string;
  url: string;
  description: string;
  tags: string[];
  categories: string[];
  sources: string[];
  lastUpdatedAt: string;
}

const rawData = resourcesData as any;
const resources: Resource[] = Array.isArray(rawData) ? rawData : (rawData.resources || []);
const lastUpdatedAt = rawData.lastUpdatedAt || new Date().toISOString();

// Group resources by category
const resourcesByCategory: Record<string, Resource[]> = {};
resources.forEach(resource => {
  if (!resource.categories) return;
  resource.categories.forEach(category => {
    if (!resourcesByCategory[category]) {
      resourcesByCategory[category] = [];
    }
    resourcesByCategory[category].push(resource);
  });
});

const sortedCategories = Object.keys(resourcesByCategory).sort();

// UTM tracking function
function addUTM(url: string): string {
  try {
    const u = new URL(url);
    u.searchParams.set('utm_source', 'vdesignu');
    u.searchParams.set('utm_medium', 'resource_list');
    u.searchParams.set('utm_campaign', 'free_developer_resources');
    return u.toString();
  } catch {
    return url;
  }
}

function slugify(text: string): string {
  return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
}
---

<Layout 
  title="Free Developer Resources" 
  description={`Browse ${resources.length}+ curated free tools, APIs, and services for developers. Synced from top community repositories including free-for.dev and freestuff.dev.`}
>
  <!-- Hero Section -->
  <section class="pt-40 pb-24 bg-[var(--bg-primary)] overflow-hidden relative">
    <div class="absolute top-0 right-0 w-[800px] h-[800px] bg-red-600/5 rounded-full blur-[150px]"></div>
    <div class="absolute bottom-0 left-0 w-[600px] h-[600px] bg-yellow-500/5 rounded-full blur-[150px]"></div>

    <div class="max-w-7xl mx-auto px-6 text-center relative z-10">
      <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-black uppercase tracking-[0.3em] mb-10 border border-red-100 dark:border-red-900/30">
        <span class="w-2 h-2 rounded-full bg-[var(--accent-red)] animate-pulse"></span>
        SEO-Optimized Library
      </div>
      
      <h1 class="text-5xl md:text-8xl font-black italic uppercase tracking-tighter text-[var(--text-primary)] mb-10 leading-[0.85]">
        Developer <span class="text-[var(--accent-red)]">Resources</span>
      </h1>
      
      <p class="text-xl md:text-2xl text-[var(--text-secondary)] leading-relaxed max-w-3xl mx-auto mb-8">
        Full collection of {resources.length} tools for developers. 
        <span class="text-[var(--accent-red)] font-bold italic uppercase">All in one place.</span>
      </p>

      <p class="text-sm text-[var(--text-muted)] font-bold uppercase tracking-widest">
        Last updated: {new Date(lastUpdatedAt).toLocaleDateString()}
      </p>
    </div>
  </section>

  <!-- Main Content with Sidebar -->
  <section class="py-16 bg-[var(--bg-secondary)]">
    <div class="max-w-[1600px] mx-auto px-6">
      <div class="flex gap-12 relative">
        
        <!-- Sticky Sidebar -->
        <aside class="hidden lg:block w-72 shrink-0 h-[calc(100vh-8rem)] sticky top-32 overflow-y-auto custom-scrollbar pr-4 border-r border-[var(--border-subtle)]">
          <h3 class="text-[10px] font-black uppercase tracking-[0.4em] text-[var(--accent-red)] mb-6 sticky top-0 bg-[var(--bg-secondary)] py-2 z-10">Categories ({sortedCategories.length})</h3>
          <nav>
            <ul class="space-y-1">
              {sortedCategories.map(category => (
                <li>
                  <a 
                    href={`#${slugify(category)}`} 
                    class="sidebar-link block py-2 px-3 text-xs font-bold text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-card)] rounded-lg transition-colors border-l-2 border-transparent hover:border-[var(--accent-yellow)]"
                    data-category={slugify(category)}
                  >
                    {category}
                    <span class="ml-1 text-[10px] opacity-60">({resourcesByCategory[category].length})</span>
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 min-w-0">
          <div class="space-y-20">
            {sortedCategories.map(category => (
              <section id={slugify(category)} class="category-section scroll-mt-32 render-optimized">
                <div class="flex items-center gap-4 mb-8 border-b border-[var(--border-subtle)] pb-4">
                  <h2 class="text-2xl md:text-4xl font-black italic uppercase tracking-tight text-[var(--text-primary)]">
                    {category}
                  </h2>
                  <span class="px-3 py-1 bg-[var(--bg-card)] text-[var(--text-muted)] text-xs font-bold rounded-full border border-[var(--border-subtle)]">
                    {resourcesByCategory[category].length}
                  </span>
                </div>

                <!-- Full List Card Layout (SEO Friendly) -->
                <div class="flex flex-col gap-4">
                  {resourcesByCategory[category].map((resource: Resource) => (
                    <article class="resource-card group relative bg-[var(--bg-card)] border-2 border-[var(--border-subtle)] rounded-2xl p-5 hover:border-[var(--accent-red)] transition-colors">
                      <div class="flex flex-col md:flex-row gap-4 md:items-start justify-between">
                        <div class="flex-1 min-w-0">
                          <h3 class="text-lg font-black italic uppercase tracking-tight text-[var(--text-primary)] mb-2 group-hover:text-[var(--accent-red)] transition-colors line-clamp-1">
                            <a href={addUTM(resource.url)} target="_blank" rel="noopener noreferrer" class="before:absolute before:inset-0 focus:outline-none">
                              {resource.title}
                            </a>
                          </h3>
                          <p class="text-sm text-[var(--text-secondary)] leading-relaxed mb-3 line-clamp-2 md:line-clamp-1">
                            {resource.description}
                          </p>
                          
                          <div class="flex flex-wrap items-center gap-2">
                            {resource.tags.slice(0, 4).map(tag => (
                              <span class="text-[10px] font-bold uppercase tracking-wider text-[var(--text-muted)] bg-[var(--bg-primary)] px-2 py-1 rounded border border-[var(--border-subtle)]">
                                #{tag}
                              </span>
                            ))}
                            <span class="text-[10px] text-[var(--text-muted)] ml-auto font-mono">
                              via {resource.sources[0]}
                            </span>
                          </div>
                        </div>

                        <div class="hidden md:flex shrink-0 items-center justify-center w-10 h-10 rounded-full bg-[var(--bg-primary)] border border-[var(--border-subtle)] group-hover:border-[var(--accent-red)] group-hover:text-[var(--accent-red)] text-[var(--text-muted)] transition-colors">
                          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                          </svg>
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              </section>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Mobile Floating Action Button -->
  <button 
    id="mobileTocBtn"
    class="fixed bottom-24 right-8 lg:hidden z-40 bg-[var(--accent-red)] text-white p-4 rounded-full shadow-2xl shadow-red-600/30 active:scale-95 transition-transform"
    aria-label="Categories"
  >
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <line x1="8" y1="6" x2="21" y2="6"></line>
      <line x1="8" y1="12" x2="21" y2="12"></line>
      <line x1="8" y1="18" x2="21" y2="18"></line>
      <line x1="3" y1="6" x2="3.01" y2="6"></line>
      <line x1="3" y1="12" x2="3.01" y2="12"></line>
      <line x1="3" y1="18" x2="3.01" y2="18"></line>
    </svg>
  </button>

  <!-- Mobile Sidebar Drawer -->
  <div id="mobileSidebar" class="fixed inset-0 z-50 lg:hidden pointer-events-none">
    <div id="sidebarBackdrop" class="absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-300"></div>
    <div id="sidebarPanel" class="absolute right-0 top-0 bottom-0 w-80 bg-[var(--bg-card)] transform translate-x-full transition-transform duration-300 shadow-2xl flex flex-col border-l border-[var(--border-subtle)] pointer-events-auto">
      <div class="p-6 border-b border-[var(--border-subtle)] flex items-center justify-between">
        <h3 class="text-[10px] font-black uppercase tracking-[0.4em] text-[var(--accent-red)]">Categories</h3>
        <button id="closeSidebarBtn" class="text-[var(--text-muted)] hover:text-[var(--text-primary)]">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="overflow-y-auto p-4 flex-1">
        <ul class="space-y-2">
          {sortedCategories.map(category => (
            <li>
              <a 
                href={`#${slugify(category)}`} 
                class="block py-3 px-4 text-sm font-bold text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-primary)] rounded-lg transition-colors mobile-link"
              >
                {category} <span class="opacity-50 text-xs ml-1">({resourcesByCategory[category].length})</span>
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
  </div>

  <style>
    /* CRITICAL FOR PERFORMANCE + SEO */
    /* content-visibility: auto skips rendering off-screen elements but keeps them in the DOM for Google */
    .category-section {
      content-visibility: auto;
      contain-intrinsic-size: 1px 1000px; /* Placeholder size for smoother scrolling */
    }

    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Active States */
    .sidebar-link.active { 
      color: var(--accent-red); 
      border-color: var(--accent-red); 
      background: var(--bg-card); 
      padding-left: 1rem;
    }
  </style>

  <script>
    // =========== Mobile Sidebar Logic ===========
    const mobileBtn = document.getElementById('mobileTocBtn');
    const closeBtn = document.getElementById('closeSidebarBtn');
    const sidebar = document.getElementById('mobileSidebar');
    const backdrop = document.getElementById('sidebarBackdrop');
    const panel = document.getElementById('sidebarPanel');
    const mobileLinks = document.querySelectorAll('.mobile-link');

    function openSidebar() {
      sidebar?.classList.remove('pointer-events-none');
      backdrop?.classList.remove('opacity-0');
      panel?.classList.remove('translate-x-full');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      backdrop?.classList.add('opacity-0');
      panel?.classList.add('translate-x-full');
      setTimeout(() => {
        sidebar?.classList.add('pointer-events-none');
        document.body.style.overflow = '';
      }, 300);
    }

    mobileBtn?.addEventListener('click', openSidebar);
    closeBtn?.addEventListener('click', closeSidebar);
    backdrop?.addEventListener('click', closeSidebar);
    mobileLinks.forEach(l => l.addEventListener('click', closeSidebar));

    // =========== Optimized ScrollSpy (Lightweight) ===========
    // Using IntersectionObserver only on category section HEADERS instead of whole sections
    // This is much lighter than observing the entire huge DOM
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const observerOptions = {
      root: null,
      rootMargin: '-10% 0px -80% 0px',
      threshold: 0
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const id = entry.target.id;
          sidebarLinks.forEach(link => {
            if (link.getAttribute('data-category') === id) {
              link.classList.add('active');
            } else {
              link.classList.remove('active');
            }
          });
        }
      });
    }, observerOptions);

    document.querySelectorAll('.category-section').forEach(section => observer.observe(section));
  </script>
</Layout>
