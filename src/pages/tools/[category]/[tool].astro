---
import Layout from '../../../layouts/Layout.astro';
import ToolSteps from '../../../components/tools/ToolSteps.astro';
import ToolCard from '../../../components/tools/ToolCard.astro';
import ToolsSidebar from '../../../components/tools/ToolsSidebar.astro';
import { toolCategories, tools, getRelatedTools } from '../../../data/tools-data';
import { toolsSEOContent } from '../../../data/tools-content';
import * as LucideIcons from 'lucide-react';
import { getCollection } from 'astro:content';
import ToolDispatcher from '../../../components/tools/ToolDispatcher';

export async function getStaticPaths() {
  const paths: any[] = [];
  
  // 1. Get Content Collection (MDX) - Map by slug for easy lookup
  const toolEntries = await getCollection('tools');
  const entryMap = new Map<string, any>();
  toolEntries.forEach(entry => {
      console.log('Found MDX Entry:', entry.slug);
      entryMap.set(entry.slug, entry);
  });

  // 2. Build Paths (Iterate all defined tools)
  toolCategories.forEach(category => {
    const categoryTools = tools.filter(t => t.categoryId === category.id);
    categoryTools.forEach(tool => {
      // Check if we have an entry for this tool
      // Try exact slug match or category/slug match
      const mdxSlug = `${category.slug}/${tool.slug}`;
      console.log(`Looking for MDX: ${mdxSlug} (Tool: ${tool.name})`);
      
      const entry = entryMap.get(mdxSlug) || null;
      if (entry) console.log(' -> MATCHED!');
      else console.log(' -> NO MATCH');

      paths.push({
        params: { category: category.slug, tool: tool.slug },
        props: { tool, category, entry }
      });
    });
  });

  return paths;
}

const { tool, category, entry } = Astro.props;
const { Content } = entry ? await entry.render() : { Content: null };
const relatedTools = getRelatedTools(tool, 3);
const IconComponent = (LucideIcons as any)[tool.icon] || LucideIcons.Wrench;

// Tool-specific SEO content
const seoContent = toolsSEOContent[tool.slug];

// Component Selection Logic is now handled by ToolDispatcher
let extraProps: any = {};
if (tool.slug.startsWith('hash-generator-')) {
  extraProps.algorithm = tool.slug.split('-').pop()?.toUpperCase() || 'MD5';
} else if (tool.slug.includes('redirects')) {
  if (tool.slug.includes('netlify')) extraProps.platform = 'Netlify';
  if (tool.slug.includes('vercel')) extraProps.platform = 'Vercel';
} else if (['linkedin-meta', 'pinterest-pins', 'instagram-meta'].includes(tool.slug)) {
  extraProps.platform = tool.slug.split('-')[0].charAt(0).toUpperCase() + tool.slug.split('-')[0].slice(1);
}

// Default steps fallback
const steps = tool.instructions || [
  'Enter your accurate data in the provided form fields.',
  'Review all configuration options and settings.',
  'Click the generate or proceed button to execute.',
  'Copy, download, or implement the professional output.'
];
---

<Layout 
  title={`${tool.name} - Free Online Tool - VDesignU`}
  description={tool.description}
>
  <!-- Breadcrumb -->
  <section class="pt-32 pb-4 bg-[var(--bg-primary)]">
    <div class="max-w-7xl mx-auto px-6">
      <nav class="flex items-center gap-2 text-sm text-[var(--text-muted)] flex-wrap">
        <a href="/tools" class="hover:text-[var(--accent-red)] transition-colors font-medium">Tools</a>
        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <a href={`/tools/${category.slug}`} class="hover:text-[var(--accent-red)] transition-colors font-medium">{category.name}</a>
        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
        <span class="text-[var(--text-primary)] font-bold truncate">{tool.name}</span>
      </nav>
    </div>
  </section>

  <!-- Main Content Layout -->
  <section class="bg-[var(--bg-secondary)] relative min-h-screen overflow-hidden">
    <div class="absolute inset-0 grid-pattern opacity-5 pointer-events-none"></div>
    
    <div class="max-w-[1600px] mx-auto px-6 pt-12">
      <div class="flex gap-12 relative items-start">
        
        <!-- Sidebar -->
        <ToolsSidebar activeCategory={category.slug} activeTool={tool.slug} />

        <!-- Main Content Area -->
        <div class="flex-1 min-w-0 pb-24">
          
          <!-- Tool Header -->
          <div class="mb-12">
             <div class="flex flex-col md:flex-row md:items-start gap-8 mb-8">
              <div class="w-20 h-20 rounded-3xl bg-[var(--accent-red)] flex items-center justify-center text-white shadow-2xl shadow-red-600/20 flex-shrink-0">
                <IconComponent className="w-10 h-10" />
              </div>
              <div>
                <div class="inline-block px-3 py-1 bg-[var(--accent-red)]/5 text-[var(--accent-red)] text-[10px] font-black uppercase tracking-widest rounded-lg mb-4">
                  Professional Tool
                </div>
                <h1 class="text-3xl md:text-5xl lg:text-6xl font-black italic uppercase tracking-tighter text-[var(--text-primary)] leading-[0.9] mb-4">
                  {tool.name}
                </h1>
                <p class="text-xl text-[var(--text-secondary)] max-w-3xl leading-relaxed">
                  {tool.description}
                </p>
              </div>
            </div>
            
            <div class="flex flex-wrap gap-2">
              {tool.keywords.map((keyword: string) => (
                <span class="px-3 py-1 bg-[var(--bg-card)] border border-[var(--border-subtle)] text-[var(--text-muted)] text-[10px] font-bold uppercase tracking-tight rounded-lg">
                  #{keyword.replace(/\s+/g, '')}
                </span>
              ))}
            </div>
          </div>

          <!-- Tool Component Container -->
          <div class="relative z-10 w-full mb-16">
            <ToolDispatcher client:load slug={tool.slug} {...extraProps} />
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- How to Use -->
  <section class="py-24 bg-[var(--bg-primary)] border-t border-[var(--border-subtle)] relative overflow-hidden">
    <div class="absolute inset-0 grid-pattern opacity-5 pointer-events-none"></div>
    <div class="max-w-5xl mx-auto px-6 relative z-10">
      <div class="mb-16 text-center">
        <h2 class="text-4xl md:text-6xl font-black italic uppercase tracking-tighter text-[var(--text-primary)] mb-6 leading-[0.9]">
          How to Use This Tool
        </h2>
        <p class="text-xl font-medium text-[var(--text-secondary)] max-w-2xl mx-auto">
          Follow these simple steps to get the most out of the {tool.name}.
        </p>
      </div>
      <div class="max-w-4xl mx-auto">
         <ToolSteps steps={steps} />
      </div>
    </div>
  </section>

  <!-- Detailed Content / Guide -->
  {Content && (
    <section class="py-24 bg-[var(--bg-secondary)] border-t border-[var(--border-subtle)] relative">
       <div class="absolute inset-0 grid-pattern opacity-5 pointer-events-none"></div>
       <div class="max-w-4xl mx-auto px-6 relative z-10">
          <div class="prose prose-lg prose-invert max-w-none">
             <Content />
          </div>
       </div>
    </section>
  )}

  <!-- Related Tools -->
  {relatedTools.length > 0 && (
    <section class="py-24 bg-[var(--bg-secondary)] border-t border-[var(--border-subtle)] relative overflow-hidden">
      <div class="max-w-7xl mx-auto px-6 relative z-10">
        <div class="flex items-center justify-between mb-16">
          <div>
            <h2 class="text-3xl md:text-5xl font-black italic uppercase tracking-tighter text-[var(--text-primary)] leading-none mb-4">
              Related Arsenal
            </h2>
            <p class="text-[var(--text-secondary)] text-lg">More specialized tools in the {category.name} category.</p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          {relatedTools.map(relatedTool => (
            <ToolCard 
              tool={relatedTool} 
              categorySlug={category.slug}
            />
          ))}
        </div>
      </div>
    </section>
  )}
</Layout>

<style is:global>
  /* Global Prose Styles (Keep existing styles) */
  .prose h2 {
    font-size: 1.875rem;
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: -0.025em;
    color: white;
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    font-style: italic;
  }
  .prose h3 {
    font-size: 1.25rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--accent-red);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  .prose p {
    color: var(--text-secondary);
    line-height: 1.625;
    margin-bottom: 1.5rem;
    font-size: 1.125rem;
  }
  .prose ul, .prose ol {
    margin-bottom: 2rem;
  }
  .prose li {
    color: var(--text-secondary);
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .prose li::before {
    content: "\2192";
    color: var(--accent-red);
    font-weight: 700;
    margin-right: 0.5rem;
  }
</style>
